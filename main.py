from sklearn.cross_decomposition import PLSRegression
from sklearn.metrics import mean_squared_error, r2_score
from sklearn.model_selection import train_test_split
from sklearn.model_selection import LeaveOneOut
import matplotlib.pyplot as plt
from cars import cars
import numpy as np
from scipy.signal import savgol_filter
import os
import pickle
import warnings
warnings.filterwarnings("ignore")

# label_data = [
# 	['0711-1-30min', 0.0999353584383726, 0.031954792746113986, 0.02034853887454404, 0.038081627056672764],
# 	['0711-1-45min', 0.1118093635011352, 0.036067487046632124, 0.0371770974220255, 0.43888574040219386],
# 	['0711-1-60min', 0.1230048539888828, 0.04077171848013817, 0.04542743555063732, 0.5629716636197442],
# 	['0711-1-75min', 0.1368100159189958, 0.04978078583765112, 0.06369457764662487, 0.8140045703839122],
# 	['0711-1-90min', 0.13832362535556772, 0.05056662348877375, 0.07161293495635067, 1.0265731261425959],
# 	['0711-1-105min', 0.14871011769618203, 0.056885708117443874, 0.08973662855035042, 1.2708510054844606],
# 	['0711-1-120min', 0.15523429630209554, 0.06210591537132988, 0.10479872125906799, 1.5791873857404024],
# 	['0711-1-135min', 0.15977512461181137, 0.0611236183074266, 0.1138646665846961, 1.7462806215722122],
# 	['0711-1-150min', 0.16170628147916177, 0.05723544905008636, 0.11149571703758351, 1.8389223034734918],
# 	['0711-1-165min', 0.1633764712022756, 0.06325012953367876, 0.11781564818230254, 1.8721307129798903],
# 	['0711-1-180min', 0.17157083953130298, 0.06394961139896374, 0.13514422722242714, 2.128721206581353],
# 	['0711-1-195min', 0.17138816253033742, 0.06583648531951641, 0.13742300913971883, 2.1540045703839126],
# 	['0711-1-210min', 0.17574631383908765, 0.06587534542314336, 0.15005057584327225, 2.3135018281535653],
# 	['0711-1-225min', 0.16624710978887758, 0.07769961139896374, 0.16713324316570352, 2.3981361974405853],
# 	['0711-1-240min', 0.16744755865236566, 0.07342068221070812, 0.16512906266650274, 2.3630356489945155],
# 	['0711-1-255min', 0.16760413893890758, 0.0766935664939551, 0.16962924710029098, 2.4865182815356492],
# 	['0711-1-270min', 0.16765633236775487, 0.07664391191709845, 0.17564588712652157, 2.5212531992687386],
# 	['0711-2-30min', 0.07986698504658264, 0.021289853195164077, 0.008663633755481783, 0.06689305301645337],
# 	['0711-2-45min', 0.09432456483728698, 0.026609369602763385, 0.014692569367597033, 0.1258053016453382],
# 	['0711-2-60min', 0.11157449307132232, 0.03585591537132988, 0.03195967047829829, 0.3725420475319927],
# 	['0711-2-75min', 0.12063005297633028, 0.03891506908462867, 0.04612008688880692, 0.6254945155393054],
# 	['0711-2-90min', 0.13099044860252093, 0.04380496545768567, 0.05705905979753268, 0.8080356489945155],
# 	['0711-2-105min', 0.13968065450559775, 0.04737793609671848, 0.07321955817861388, 1.0994433272394881],
# 	['0711-2-120min', 0.1484491505519455, 0.05177776338514681, 0.0857364646092053, 1.3136755027422302],
# 	['0711-2-135min', 0.1565130353088546, 0.055724222797927464, 0.09573687446206812, 1.5182915904936014],
# 	['0711-2-150min', 0.15948806075315117, 0.057604620034542316, 0.10563482109922538, 1.6587303473491775],
# 	['0711-2-165min', 0.16301111720034447, 0.05879417098445596, 0.108557072011148, 1.7445621572212067],
# 	['0711-2-180min', 0.1680477830841097, 0.06307094127806563, 0.1285333005451043, 2.0013903107861064],
# 	['0711-2-195min', 0.1716230329601503, 0.06575444732297064, 0.13461961555801466, 2.0971489945155395],
# 	['0711-2-210min', 0.17214496724862338, 0.06529244386873921, 0.12903332103774745, 2.042980804387569],
# 	['0711-2-225min', 0.17932156371512825, 0.06856964594127807, 0.1467143735398992, 2.2735566727605123],
# 	['0711-2-240min', 0.17572021712466399, 0.07167845423143351, 0.1514973564490348, 2.299717550274223],
# 	['0711-2-255min', 0.18039152900649807, 0.07495349740932643, 0.16743243575556377, 2.4193153564899452],
# 	['0711-2-270min', 0.18404506902580964, 0.07219658894645942, 0.16080921349235625, 2.415668190127971],
# 	['0711-3-15min', 0.08273762363318458, 0.024482858376511228, 0.015573753022664864, 0.16426965265082266],
# 	['0711-3-30min', 0.10144896787494455, 0.030335621761658032, 0.027213574326816675, 0.3511709323583181],
# 	['0711-3-45min', 0.11207033064537174, 0.03636757340241796, 0.04741522193532522, 0.6823226691042048],
# 	['0711-3-60min', 0.1181247683916595, 0.039599438687392054, 0.05234575187507685, 0.7585201096892138],
# 	['0711-3-75min', 0.12770226258514053, 0.04446126943005181, 0.07167031435714578, 1.114790676416819],
# 	['0711-3-105min', 0.1424730029489287, 0.05064434369602763, 0.09541718922906677, 1.5461892138939672],
# 	['0711-3-120min', 0.14779673269135413, 0.05684900690846287, 0.10388065084634615, 1.7056133455210238],
# 	['0711-3-135min', 0.1503803074192959, 0.058766105354058726, 0.11066371572605434, 1.816829067641682],
# 	['0711-3-150min', 0.13738414363631618, 0.059832599309153724, 0.12563973933357925, 2.0614177330895793],
# 	['0711-3-165min', 0.14007210522195254, 0.06282482728842834, 0.13074650600434443, 2.1156773308957955],
# 	['0711-3-180min', 0.13939359064693754, 0.06355885146804836, 0.1355007992130825, 2.1944341864716637],
# 	['0711-3-195min', 0.14422148281531355, 0.06538743523316062, 0.139857535144883, 2.2646444241316273],
# 	['0711-3-210min', 0.16246308619744773, 0.06379201208981002, 0.14309537276117873, 2.2840045703839125],
# 	['0711-3-225min', 0.16888287794566664, 0.07020392918825562, 0.15369006926513382, 2.3925329067641683],
# 	['0711-3-240min', 0.17337151282653512, 0.0713697322970639, 0.15845255953112833, 2.4249826325411337],
# 	['0711-3-255min', 0.17313664239672222, 0.07403812607944733, 0.1689939751629165, 2.5419478976234005],
# 	['0711-4-15min', 0.05082134189305566, 0.013822236614853194, 0.004995450633222673, 0.04391316270566727],
# 	['0711-4-30min', 0.07952772775907513, 0.021009196891191708, 0.01244657567933112, 0.11105210237659964],
# 	['0711-4-45min', 0.09309801925937525, 0.027595984455958546, 0.02262322226320751, 0.25483638025594146],
# 	['0711-4-60min', 0.10442399331924111, 0.03164822970639033, 0.034140087708512644, 0.4516371115173675],
# 	['0711-4-75min', 0.11924692711187661, 0.03918924870466321, 0.05723119799991803, 0.8968290676416819],
# 	['0711-4-105min', 0.13540079334011845, 0.048908592400690856, 0.07978540104102627, 1.2967102376599635],
# 	['0711-4-120min', 0.14075061979696754, 0.05079546632124352, 0.09454830115988361, 1.5709241316270566],
# 	['0711-4-135min', 0.14612654296824026, 0.05339261658031089, 0.09410156153940735, 1.593538391224863],
# 	['0711-4-150min', 0.15184172342702051, 0.059044602763385155, 0.1170779130292225, 1.0118382084095063],
# 	['0711-4-165min', 0.1532248492914742, 0.06079762521588947, 0.12573810402065658, 1.9912714808043877],
# 	['0711-4-180min', 0.15455578172708057, 0.058543739205526774, 0.11681560719701628, 1.9697998171846436],
# 	['0711-4-195min', 0.16473350035230563, 0.06591636442141624, 0.13976326898643388, 2.2494798903107864],
# 	['0711-4-210min', 0.16444643649364543, 0.06549537996545769, 0.13918947497848272, 2.277551188299817],
# 	['0711-4-225min', 0.16956139252068164, 0.0689064335060449, 0.15028419197508094, 2.3729259597806216],
# 	['0711-4-240min', 0.16705610793601083, 0.07013268566493956, 0.1521941063158326, 2.382304387568556],
# 	['0711-4-255min', 0.17219716067747068, 0.07149926597582038, 0.1576451493913685, 2.4527979890310787],
# 	['0716-1-45min', 0.1065900206164044, 0.03383950777202072, 0.03032845608426575, 0.33867550274223035],
# 	['0716-1-60min', 0.11679383595605314, 0.039769991364421414, 0.04166908479855732, 0.4905859232175503],
# 	['0716-1-75min', 0.12702374801012553, 0.044994516407599314, 0.06028050329931555, 0.7761252285191955],
# 	['0716-1-90min', 0.13339134632949712, 0.045998402417962006, 0.06319455715398171, 0.9318382084095064],
# 	['0716-1-105min', 0.14108987708447507, 0.0528075561312608, 0.07766236321160704, 1.1825786106032907],
# 	['0716-1-120min', 0.1503803074192959, 0.05432741796200346, 0.10194204680519692, 1.5478071297989033],
# 	['0716-1-135min', 0.15207659385683342, 0.05631575993091538, 0.10723734579286036, 1.662121572212066],
# 	['0716-1-150min', 0.1582876118896631, 0.06023199481865286, 0.12205352678388458, 1.878721206581353],
# 	['0716-1-165min', 0.165385918212897, 0.0647786269430052, 0.13155801467273248, 2.0142239488117],
# 	['0716-1-180min', 0.1670300112215872, 0.06460591537132988, 0.14191499651625067, 2.139900365630713],
# 	['0716-1-195min', 0.16888287794566664, 0.06673026770293611, 0.143984753473503, 2.2032184643510058],
# 	['0716-1-210min', 0.17637263498525532, 0.0709876079447323, 0.14826361736136726, 2.282085009140768],
# 	['0716-1-225min', 0.1700311333803074, 0.069675, 0.14331259477847452, 2.26786197440585],
# 	['0716-1-240min', 0.17942595057282287, 0.07480453367875649, 0.16413312020984466, 2.3890228519195613],
# 	['0716-1-255min', 0.17989569143244863, 0.07448501727115717, 0.1663668183122259, 2.4734378427787935],
# 	['0716-1-270min', 0.18028714214880343, 0.07731964594127808, 0.17901897618754867, 2.4474780621572214],
# 	['0716-2-45min', 0.09424627469401603, 0.02712966321243523, 0.022369113488257715, 0.24706672760511883],
# 	['0716-2-60min', 0.11019136720686866, 0.034774309153713295, 0.038357473666953565, 0.5208418647166362],
# 	['0716-2-75min', 0.12180440512539471, 0.039461269430051814, 0.050390753719414726, 0.7193153564899452],
# 	['0716-2-90min', 0.12731081186878573, 0.0425571243523316, 0.064194598139268, 0.9883647166361974],
# 	['0716-2-105min', 0.13772340092382368, 0.048809283246977545, 0.0774738308947088, 1.2038583180987201],
# 	['0716-2-120min', 0.14221203580469216, 0.04814434369602764, 0.07245313332513628, 1.1366005484460695],
# 	['0716-2-135min', 0.14915376184138415, 0.0538222366148532, 0.09589261854994058, 1.5577888482632543],
# 	['0716-2-150min', 0.15499942587228266, 0.05761973229706391, 0.10892184105905979, 1.7653848263254115],
# 	['0716-2-165min', 0.15768738745791905, 0.057794602763385154, 0.11215558014672734, 1.8348089579524682],
# 	['0716-2-180min', 0.16092338004645215, 0.061756174438687396, 0.1194837493339891, 1.915265996343693],
# 	['0716-2-195min', 0.16614272293118296, 0.06231532815198619, 0.13291872617730235, 2.120375685557587],
# 	['0716-2-210min', 0.16849142722931182, 0.06386757340241796, 0.1261930406983893, 2.049077696526508],
# 	['0716-2-225min', 0.16977016623607086, 0.06649063039723661, 0.1517350711094717, 2.309150822669104],
# 	['0716-2-240min', 0.1702399070956966, 0.06992111398963731, 0.15582950120906594, 2.3085383912248627],
# 	['0716-2-255min', 0.17266690153709646, 0.0696901122625216, 0.15448108529038077, 2.3262989031078614],
# 	['0716-2-270min', 0.17350199639865338, 0.07146688255613126, 0.1703751793106275, 2.421189213893967],
# 	['0716-3-30min', 0.0812501109110363, 0.028351597582037993, 0.020553465305955164, 0.24353839122486287],
# 	['0716-3-45min', 0.09281095540071506, 0.03239736614853195, 0.02940218861428747, 0.3922038391224863],
# 	['0716-3-60min', 0.11274884522038675, 0.030210405872193438, 0.03702955039140948, 0.5955767824497258],
# 	['0716-3-75min', 0.12263949998695163, 0.03779892055267703, 0.05602623058322062, 0.8909058500914077],
# 	['0716-3-90min', 0.12843297058900285, 0.048010492227979276, 0.08051084060822165, 1.305119744058501],
# 	['0716-3-105min', 0.13179944674965421, 0.05324365284974093, 0.09428599532767735, 1.5066462522851918],
# 	['0716-3-120min', 0.13678391920457214, 0.05521256476683939, 0.1064955121111521, 1.715723034734918],
# 	['0716-3-135min', 0.13579224405647328, 0.056721632124352335, 0.1110940612320177, 1.8145712979890312],
# 	['0716-3-150min', 0.14852744069521645, 0.060709110535405876, 0.12354129267592932, 2.004269652650823],
# 	['0716-3-165min', 0.14364735509799315, 0.060877504317789294, 0.11794680109840566, 1.9518656307129798],
# 	['0716-3-180min', 0.14633531668362953, 0.06281403281519862, 0.13041452518545843, 2.0990502742230346],
# 	['0716-3-195min', 0.14967569612985723, 0.06518018134715026, 0.1400747571621788, 2.201701096892139],
# 	['0716-3-210min', 0.1532248492914742, 0.0681788860103627, 0.14430034017787616, 2.225284277879342],
# 	['0716-3-225min', 0.15763519402907172, 0.0702708549222798, 0.16061248411820156, 2.3587760511883],
# 	['0716-3-240min', 0.16136702419165425, 0.06988657167530225, 0.15968211811959507, 2.422825411334552],
# 	['0716-3-255min', 0.16194115190897465, 0.07298890328151986, 0.16494872740686092, 2.453282449725777],
# 	['0716-3-270min', 0.16413327592056157, 0.07260677892918826, 0.1624404278863888, 2.4327157221206583],
# 	['0716-4-30min', 0.07391693415798951, 0.02367543177892919, 0.014151563588671666, 0.14254204753199268],
# 	['0716-4-45min', 0.0902795741016206, 0.032559283246977544, 0.028414443214885857, 0.3335201096892139],
# 	['0716-4-60min', 0.1065900206164044, 0.0375463298791019, 0.04389458584368212, 0.6299643510054845],
# 	['0716-4-75min', 0.11627190166758006, 0.0419396804835924, 0.05644428050329931, 0.8454853747714807],
# 	['0716-4-90min', 0.1240226258514053, 0.04616679620034543, 0.07472371818517153, 1.208373857404022],
# 	['0716-4-105min', 0.13041632088520055, 0.049208678756476686, 0.07976490839788516, 1.2823866544789762],
# 	['0716-4-120min', 0.13506153605261095, 0.05745565630397237, 0.09684347719168819, 1.54322760511883],
# 	['0716-4-135min', 0.13861068921422792, 0.056389162348877385, 0.11327447846223204, 1.8441325411334553],
# 	['0716-4-150min', 0.14409099924319527, 0.060909887737478415, 0.13168916758883562, 2.071426873857404],
# 	['0716-4-165min', 0.1453697382499543, 0.06195479274611399, 0.1282382064838723, 2.021079524680073],
# 	['0716-4-180min', 0.15254633471645918, 0.06565082037996546, 0.13694348129021683, 2.138867458866545],
# 	['0716-4-195min', 0.15139807928181842, 0.06542629533678757, 0.14371834911266854, 2.21895886654479],
# 	['0716-4-210min', 0.1533292361491688, 0.06802560449050087, 0.1405337923685397, 2.193794332723949],
# 	['0716-4-225min', 0.15695667945405672, 0.07099408462867013, 0.14570613549735645, 2.276070383912249],
# 	['0716-4-240min', 0.1600882851848952, 0.0732674006908463, 0.1448905283003402, 2.252633455210238],
# 	['0716-4-255min', 0.1636635350609358, 0.07461670984455959, 0.16661682855854748, 2.419278793418647],
# 	['0716-4-270min', 0.16449862992249273, 0.07277085492227979, 0.16857182671420962, 2.4722769652650824]
# ]
#
# raw_dir = './raw_data/'
#
# x_data = []
# x_der_data = []
# x_sg_data = []
# y_data = []
#
# for data in label_data:
# 	file_name = raw_dir + data[0] + '_ref.raw'
# 	if os.path.exists(file_name):
# 		raw_file = np.fromfile(file_name, dtype=np.float32)
# 		format_img = np.zeros((703, 800, 128))
# 		for row in range(703):
# 			for dim in range(128):
# 				format_img[row, :, dim] = raw_file[(dim + row * 128) * 800:(dim + 1 + row * 128) * 800]
# 		x_data.append(format_img.mean(axis=0).mean(axis=0))
# 		x_der_data.append(np.abs(np.diff(format_img, axis=0)).mean(axis=0).mean(axis=0))
# 		x_sg_data.append(savgol_filter(format_img, 59, 3, mode="nearest").mean(axis=0).mean(axis=0))
# 		y_data.append(data[1:])
# 	print(file_name)
# pickle.dump((x_data, x_der_data, x_sg_data, y_data), open('process_data', 'wb'))
x_data, x_der_data, x_sg_data, y_data = pickle.load(open('process_data', 'rb'))
total_x = {
	'原始数据': x_data,
	'一阶导数': x_der_data,
	'SG平滑': x_sg_data,
}

total_y = {
	'DSS': 0,
	'AWS': 1,
	'MDXS': 2,
	'DFSB': 3,
}

for key, value in total_x.items():
	for y_key, y_index in total_y.items():
		x = value
		y = np.array(y_data)[:, y_index]
		img_name = '{}_{}'.format(key, y_key)
		channel_index, _ = cars(np.array(x), y, img_name)
		while len(channel_index) < 20:
			channel_index, _ = cars(np.array(x), y, img_name)
		print('{}-{},波段选择数量:{},具体波段:{}'.format(key, y_key, len(channel_index), channel_index))
		x = np.array(x)[:, channel_index]
		loo = LeaveOneOut()
		y_res = []
		y_pred = []
		for train, test in loo.split(x):
			pls = PLSRegression(n_components=10)
			pls.fit(x[train], y[train])
			y_res.append(y[test][0])
			y_pred.append(pls.predict(x[test])[0][0])
		one_r = r2_score(y_res, y_pred)
		one_rmse = np.sqrt(mean_squared_error(y_res, y_pred))
		print('{}-{},留一验证R2:{:.3f},留一验证RMSE:{:.3f}'.format(key, y_key, one_r, one_rmse))
		x_train, x_test, y_train, y_test = train_test_split(x, y, test_size=0.2)
		pls = PLSRegression(n_components=10)
		pls.fit(x_train, y_train)
		test_r = pls.score(x_test, y_test)
		test_rmse = np.sqrt(mean_squared_error(y_test, pls.predict(x_test)))
		print('{}-{},测试集R2:{:.3f},测试集RMSE:{:.3f}'.format(key, y_key, test_r, test_rmse))
		fig_name = '{}_{}_验证拟合图'.format(key, y_key)
		fig = plt.figure()
		plt.rcParams['font.sans-serif'] = [u'Arial Unicode MS']
		fonts = 16
		plt.scatter(y_train, pls.predict(x_train), c='r', label='train')
		plt.scatter(y_test, pls.predict(x_test), c='b', label='test')
		plt.plot([y.min(), y.max()], [y.min(), y.max()])
		plt.legend()
		plt.xlabel('观测值', fontsize=fonts)
		plt.ylabel('预测值', fontsize=fonts)
		fig.savefig('{}.png'.format(fig_name))
		plt.close(fig)
